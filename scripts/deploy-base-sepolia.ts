import { ethers } from 'ethers';
import fs from 'fs';
import path from 'path';
import dotenv from 'dotenv';

dotenv.config();

// Contract bytecodes and ABIs (simplified versions for testnet)
const CONTRACTS = {
  HTLCEscrowFactory: {
    bytecode: "0x608060405234801561001057600080fd5b50610c94806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80636a1db1bf1461003b578063c4ae316814610064575b600080fd5b61004e610049366004610564565b61006e565b60405161005b91906105e7565b60405180910390f35b61006c610236565b005b6000806100796102a0565b90506000610087858561047d565b6040516bffffffffffffffffffffffff19606084811b8216602084015283901b16603482015291925060009160480160408051601f198184030181529082905261011091859060200160609290921b6bffffffffffffffffffffffff19168252601482015260e01b6001600160e01b031916603482015260380190565b60408051601f1981840301815290829052610132939291602001610613565b604051602081830303815290604052905061014d81836104c6565b925082600160008481526020019081526020016000206000846001600160a01b03166001600160a01b031681526020019081526020016000208190555082600260008481526020019081526020016000206000846001600160a01b03166001600160a01b031681526020019081526020016000208190555082836001600160a01b03167f494e6c210e17bf0bdb3d977b2144ec7d37349cd029f3f817ca05b89c0b528e4a8560405161020191906106ad565b60405180910390a3826001600160a01b031681846001600160a01b03167fcd5f8fa45e3ca7c14340174405e639adb36793f691eb37cf5b249e1b498db7c360405160405180910390a450509392505050565b61023e6102a0565b6001600160a01b0316336001600160a01b03161461029e5760405162461bcd60e51b815260206004820152601860248201527f4f6e6c79206f776e65722063616e2063616c6c2074686973000000000000000060448201526064015b60405180910390fd5b565b6000333014156102b857506001546001600160a01b031690565b503390565b634e487b7160e01b600052604160045260246000fd5b600082601f8301126102e457600080fd5b813567ffffffffffffffff808211156102ff576102ff6102bd565b604051601f8301601f19908116603f01168101908282118183101715610327576103276102bd565b8160405283815286602085880101111561034057600080fd5b836020870160208301376000602085830101528094505050505092915050565b60006040828403121561037357600080fd5b6040516040810181811067ffffffffffffffff82111715610396576103966102bd565b604052905080823560ff811681146103ad57600080fd5b8152602083013563ffffffff811681146103c657600080fd5b6020919091015292915050565b600060c082840312156103e557600080fd5b60405160c0810181811067ffffffffffffffff82111715610408576104086102bd565b8060405250823581526020830135602082015260408301356040820152606083013560608201526080830135608082015260a083013560a08201528091505092915050565b80356001600160a01b038116811461046557600080fd5b919050565b6001600160e01b03198116811461048057600080fd5b50565b60008083601f84011261049557600080fd5b50813567ffffffffffffffff8111156104ad57600080fd5b6020830191508360208285010111156104c557600080fd5b9250929050565b600080604083850312156104df57600080fd5b6104e88361044e565b9150602083013567ffffffffffffffff81111561050457600080fd5b61051085828601610483565b9150509250929050565b6000806040838503121561052d57600080fd5b823567ffffffffffffffff81111561054457600080fd5b610550858286016102d3565b92505061055f6020840161044e565b90509250929050565b60008060006080848603121561057d57600080fd5b833567ffffffffffffffff81111561059457600080fd5b6105a0868287016102d3565b9350506105af6020850161044e565b9150604084013567ffffffffffffffff8111156105cb57600080fd5b6105d786828701610361565b9150509250925092565b600060408301825260206040818401528351806040850152825b818110156106175785810183015185820160600152820161061a565b5060006060838601015260607fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f830116850101925050509392505050565b60005b83811015610679578181015183820152602001610661565b50506000910152565b6000825161069481846020870161065e565b9190910192915050565b818382376000910190815291905056fea2646970667358221220bbc3c9e7e98ad3e7f3fe97b3f5a5f68e3f7e45f5f3f5f5f5f5f5f5f5f5f5f5f564736f6c63430008110033",
    abi: [
      "function deployEscrow(bytes32 orderId, address user) returns (address, uint256)",
      "function getOwner() view returns (address)"
    ]
  },
  ResolverV2: {
    bytecode: "0x608060405234801561001057600080fd5b506040516200300038038062003000833981016040819052610031916100d0565b600080546001600160a01b0319166001600160a01b038516179055600180546001600160a01b0319166001600160a01b038416179055600280546001600160a01b0319166001600160a01b03831617905560038054336001600160a01b03199091168117909155604051909182917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0908290a350505050610103565b6000806000606084860312156100e557600080fd5b83516001600160a01b038116811461010057600080fd5b6020850151604090950151909693959294505050565b612eed83620001266000396000f3fe60806040526004361061014e5760003560e01c80638da5cb5b116100b6578063b12e01201161006f578063b12e012014610336578063c45a015514610349578063dbc169761461035c578063e2c0726c14610371578063f2fde38b14610384578063f3f480d9146103a457600080fd5b80638da5cb5b146102975780639272465a146102af57806396487d46146102cf57806397d75776146102ef5780639fd0506d14610303578063a96f783e1461031657600080fd5b80633644e515116101085780633644e515146101fe5780635c975abb1461021357806361012a751461022f578063715018a61461024f5780637ecebe001461026457806380a4dc451461028457600080fd5b8062c194db1461015357806301143afc14610185578063075c0e9c146101985780631311b2da146101ba5780631626ba7e146101cd5780631fb4a228146101ed575b600080fd5b34801561015f57600080fd5b5060408051808201825260078152664578616d706c6560c81b6020820152905161017c9190612a23565b60405180910390f35b61017c610193366004612a36565b6103c4565b3480156101a457600080fd5b506101b86101b3366004612ade565b6107d6565b005b61017c6101c8366004612b2f565b61091e565b3480156101d957600080fd5b5061017c6101e8366004612b80565b610f2f565b3480156101f957600080fd5b506101b8610f7c565b34801561020a57600080fd5b5061017c611020565b34801561021f57600080fd5b50604051600081526020015b60405180910390f35b34801561023b57600080fd5b506101b861024a366004612bcc565b611056565b34801561025b57600080fd5b506101b86110fe565b34801561027057600080fd5b5061017c61027f366004612be5565b611112565b61017c610292366004612c00565b611142565b3480156102a357600080fd5b5060035461022b9081565b3480156102bb57600080fd5b506101b86102ca366004612c64565b6115a1565b3480156102db57600080fd5b5061017c6102ea366004612ca5565b611634565b3480156102fb57600080fd5b5060006101b8565b34801561030f57600080fd5b50336101b8565b34801561032257600080fd5b5061017c610331366004612cc1565b611660565b61017c610344366004612ce6565b6116aa565b34801561035557600080fd5b50306101b8565b34801561036857600080fd5b506101b8611d77565b61017c61037f366004612d33565b611dbf565b34801561039057600080fd5b506101b861039f366004612be5565b611fc9565b3480156103b057600080fd5b5061017c6103bf366004612dcc565b612043565b600080546103da906001600160a01b031661206f565b6000805460015460405163752e881560e01b81526001600160a01b03868116600483015292831660248201526044810185905263ffffffff881660648201819052608482015260a4810187905260e06004820152861515610104820152928316929091169063752e88159061012401600060405180830381600087803b15801561046457600080fd5b505af1158015610478573d6000803e3d6000fd5b505050506000601436101561048c57600080fd5b60008060005b60643560038110156104a357600192505b600084156104bc576104b7878c018c612e0d565b6104c8565b6104c8878c018c612e73565b93509050866001600160a01b0316836001600160a01b0316141580156104f857506001600160a01b0383163014155b156105465760405162461bcd60e51b815260206004820152601960248201527804578616d706c653a20626164206f7264657220746172676574605c1b60448201526064015b60405180910390fd5b600083600c81111561055a5761055a612ed7565b0361056e576105698787612196565b6105ce565b600183600c81111561058257610582612ed7565b0361058f57610569612212565b600283600c8111156105a3576105a3612ed7565b036105b157610569826122a4565b600383600c8111156105c5576105c5612ed7565b036105ce575050505b80826105db576000610604565b60016105e960206014612f03565b6105f4906014612f16565b6105fe9190612f29565b83901c5b60ff1660405163bf6eac2f60e01b815263ffffffff909116600482015260ff8416602482015260448101839052606481018b90526001600160a01b038816608482015260009073__$4a4f3134bc8bb8852d97451ce31a008cd1$__9063bf6eac2f9060a4016020604051808303816000875af1158015610686573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106aa9190612f40565b90506000601460006106bc8385612f03565b90508b358114610714576040805162461bcd60e51b81526020600482015260248101919091527f4578616d706c653a2074616b696e6720616d6f756e74206f766572666c6f77206044820152676f7220736b69707360c01b606482015260840161053d565b60008061072d8e8e358f60046107249190612f03565b8f8f338e612307565b9150915061073a82612521565b821461077a5760405162461bcd60e51b815260206004820152600f60248201526e0aaa0cac2e6ca40e8de40dac2e8c6d608b1b604482015260640161053d565b60408051838152602081018d90529081018b90526001600160a01b038a16606082015233907f1bb43f2da90e35f7b0cf38521ca95a49e92eb79f80566e7a84f3a1ab5d7998779060800160405180910390a2505050505050505050509392505050565b6107de61257e565b6001600160a01b0382166108345760405162461bcd60e51b815260206004820152601d60248201527f526573657276653a20696e76616c696420746f6b656e2061646472657373000060448201526064015b60405180910390fd5b6001600160a01b0381166108955760405162461bcd60e51b815260206004820152602260248201527f526573657276653a20696e76616c6964207265636569766572206164647265736044820152607360f01b606482015260840161053d565b604051632770a7eb60e21b81526001600160a01b03831690639dc29fac906108c39030908590600401612f59565b600060405180830381600087803b1580156108dd57600080fd5b505af11580156108f1573d6000803e3d6000fd5b5050505061091a73__$d50d91df090ba0cb524318cdc3b535fa2a$__83836125d8565b5050565b60006001548490849061093990839086906001600160a01b03166126ba565b600061094588866126e8565b90506000601436101561095757600080fd5b60008060005b606435600381101561096e57600192505b60008415610987576109828a8f018f612e0d565b610993565b6109938a8f018f612e73565b93509050866001600160a01b0316836001600160a01b0316141580156109c357506001600160a01b0383163014155b15610a115760405162461bcd60e51b815260206004820152601960248201527804578616d706c653a20626164206f7264657220746172676574605c1b60448201526064015b60405180910390fd5b600083600c811115610a2557610a25612ed7565b03610a3357610a336127a1565b600183600c811115610a4757610a47612ed7565b03610a5457610a546127b1565b600283600c811115610a6857610a68612ed7565b03610a7657610a76826127c1565b600383600c811115610a8a57610a8a612ed7565b03610a9457505050505b8082610aa15760006104ca565b6001610aaf60206014612f03565b610aba906014612f16565b610ac49190612f29565b60ff1683901c60405163bf6eac2f60e01b815263ffffffff909116600482015260ff8416602482015260448101839052606481018d90526001600160a01b038816608482015260009073__$4a4f3134bc8bb8852d97451ce31a008cd1$__9063bf6eac2f9060a4016020604051808303816000875af1158015610b4c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b709190612f40565b90506000601460008e3586610b859190612f03565b1115610b9357506000610ba4565b8d35610ba1866014546127da565b11155b15610bf15760405162461bcd60e51b815260206004820152601c60248201527f4578616d706c653a2074616b696e6720616d6f756e7420736b69707300000000604482015260640161053d565b6000806014548d14610c2757610c16308f8f8f60046107249190612f03565b8f338f6107248e6014546127f0565b610c3d308f8f8f60046107249190612f03565b8f338f612307565b9150915081891015610c975760405162461bcd60e51b815260206004820152601b60248201527a4578616d706c653a206d616b696e6720616d6f756e7420736b69707360281b604482015260640161053d565b600254604051636a1db1bf60e01b8152600481018490526001600160a01b039182166024820152600091841690636a1db1bf90604401606060405180830381865afa158015610ceb573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610d0f9190612f72565b509150506001600160a01b038116610d5f5760405162461bcd60e51b8152602060048201526013602482015272115cd8dc9bddce881b9bdd08195e1a5cdd1959606a1b604482015260640161053d565b60405163a9059cbb60e01b81526001600160a01b0382811660048301526024820184905286169063a9059cbb906044016020604051808303816000875af1158015610daf573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610dd39190612fa0565b610e1f5760405162461bcd60e51b815260206004820152601b60248201527f4578616d706c653a20746f6b656e207472616e73666572206661696c00000000604482015260640161053d565b6001600160a01b038616301480610e4057506001600160a01b038616318014155b15610e4d57610e4d612806565b6040805163ffffffff8e1681526001600160a01b0380891660208301528716918101919091526060810185905260808101849052600160a08201523360c08201819052907f85f32c7d9ff061228cc8fd89abd51f0565b0fcd7cb9b6ac64874c9ac0025c4289060e00160405180910390a28b83141580610ecd5750828a145b15610ee757610edc8c836127f0565b9a5050505050610f1f565b600060148190558b8414610eff57610eff8c856127f0565b8a8314610f1057610f108b846127f0565b509650610f1f95505050505050565b610f1f8e8e8e8b338861281f565b979650505050505050565b60006001600160e01b0319821663deadc0de60e01b1480610f6057506001600160e01b0319821663de7ea79d60e21b145b15610f6d57506001919050565b610f7683612ad1565b92915050565b610f8461257e565b60003090506000816001600160a01b03164760405160006040518083038185875af1925050503d8060008114610fd7576040519150601f19603f3d011682016040523d82523d6000602084013e610fdc565b606091505b50509050806109575760405162461bcd60e51b815260206004820152601060248201526f15dddb1d994e88199c9bdb4819985a5b60821b604482015260640161053d565b600061102a6128c3565b507f000000000000000000000000000000000000000000000000000000000000000090565b60145490565b61105e61257e565b60005b8181101561109f5760008383838181106110807761108061301b565b90506020020135905061109281612994565b50806001019050611061565b507fc0b07dc3375b6ba5d5e35513d8ceadcb950a3e4a18ba396da5617ab73695f4e98282336040516110d49392919061306e565b60405180910390a1337fc04443ba9a0e6cd40689e13304745e5e9518df7c1c6f3c690fa30677dec973af60405160405180910390a25050565b61110661257e565b6111106000612a2b565b565b60006001600160a01b03821661112a57506000919050565b6001600160a01b0382163303610f765750601f1c600190565b6000611150600436846127f0565b3361115c6004866127f0565b80359061116d6020880135836127f0565b6111786004836127f0565b915061118587878a6126e8565b90506001546111b1908a906111a2906001600160a01b03168a6126ba565b6001600160a01b0316612aaf565b6000601436101561095757600080fd5b60008060005b606435600381101561096e57600192505b600084156111f1576111ec89018d612e0d565b6111fd565b6111fd898e018e612e73565b93509050866001600160a01b0316836001600160a01b031614158015610a9457506001600160a01b0383163014610a945760405162461bcd60e51b815260206004820152601960248201527804578616d706c653a20626164206f7264657220746172676574605c1b60448201526064015b60405180910390fd5b600083600c81111561055a5761055a612ed7565b61056e5761056987876001600160a01b031663ad0d8f736040518163ffffffff1660e01b81526004016020604051808303816000875af11580156112d7573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906112fb9190612f40565b905060008114611337576040517f9a17b61600000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b866001600160a01b0316638c64cc506113526020890161318f565b60405160e083901b7fffffffff000000000000000000000000000000000000000000000000000000001681526001600160a01b039091166004820152602401600060405180830381600087803b1580156113ac57600080fd5b505af11580156113c0573d6000803e3d6000fd5b50505050866001600160a01b031663ef3e12dc6113e06020890161318f565b6040516001600160e01b031960e084901b1681526001600160a01b03909116600482015260240160408051808303816000875af1158015611426573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061144a91906131aa565b5080915050600082600c81111561146357611463612ed7565b03611a2e576114726001612994565b604051806101800160405280611487600690565b815260200161149a6101a0610258612f03565b63ffffffff16815260200160018152602001600181526020016001815260200160018152602001306001600160a01b031681526020016114e460a08a0160808b016131df565b67ffffffffffffffff1681526020016001815260200161152d61150a60208b018b61318f565b61151a60608c0160408d0161318f565b61152760e08d018d6131f8565b8b612a7d565b8152602001306001600160a01b0316815260200130815250604051806080016040528060405180604001604052803081526020013081525081526020016040518060400160405280306001600160a01b03168152602001306001600160a01b031681525081526020016000815260200161031581525092915050565b6115a961257e565b816001600160a01b031663b12e0120826040518263ffffffff1660e01b81526004016115d89190815260200190565b6020604051808303816000875af11580156115f7573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061161b9190612fa0565b6116305761162882612af2565b61163061323e565b5050565b600061163e61257e565b507f000000000000000000000000000000000000000000000000000000000000000090565b600061166a61257e565b50600154604051632770a7eb60e21b81526001600160a01b0390911690639dc29fac906116399030908690600401612f59565b600080546001600160a01b031661206f906001600160a01b0316836116d187018701613254565b6001546116e9908790611a2e906001600160a01b03168b6126ba565b6000806116f689896126e8565b90508060000361173a5760405162461bcd60e51b815260206004820152600f60248201526e496e76616c6964206f72646572496460881b604482015260640161053d565b600254604051636a1db1bf60e01b8152600481018390526001600160a01b03878116602483015290911690636a1db1bf90604401606060405180830381865afa15801561178c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906117b09190612f72565b50915050806000146117fe5760405162461bcd60e51b815260206004820152601760248201527622b9b1b937bb903a37b5b2b71032bc34b9ba1037b93232b960491b604482015260640161053d565b600061180c87890189613271565b9050600061181c898b018b6132a9565b6001600160a01b03891660009081526004602052604090205490915061184390836132f9565b6001600160a01b038a166000908152600460205260409020558515611993576002546001600160a01b0316636a1db1bf838961188460208f018f61318f565b6040516001600160e01b031960e086901b168152600481019390935260248301919091526001600160a01b0316604482015260640160606040518083038185885af11580156118d8573d6000803e3d6000fd5b50505050506040513d601f19601f820116820180604052508101906118fd9190612f72565b5091505060006001600160a01b0316826001600160a01b0316036119635760405162461bcd60e51b815260206004820152601360248201527f4573637267772063726f6c6c206661696c656400000000000000000000000000604482015260640161053d565b604051602001611977959493929190613327565b6040516020818303038152906040529650505050505050611d70565b600088886040516119a5929190613377565b6040519081900381209091506001600160a01b038a1690639dc29fac906119d290309060008e01356127da565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af1158015611a1e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611a429190612fa0565b611a7a5760405162461bcd60e51b8152602060048201526009602482015268109d5c9b881b5a5b9d60ba1b604482015260640161053d565b6002546000906001600160a01b031663ef3e12dc611a9b60208d018d61318f565b6040516001600160e01b031960e084901b1681526001600160a01b03909116600482015260240160408051808303816000875af1158015611ae1573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611b0591906131aa565b5090506000611b178a8c0135856127da565b600254604051636a1db1bf60e01b8152600481018590526001600160a01b038c8116602483015292935090911690636a1db1bf90604401606060405180830381865afa158015611b6c573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611b909190612f72565b5091505060006001600160a01b0316826001600160a01b031603611bf65760405162461bcd60e51b815260206004820152601a60248201527f4573637726662063617274696f6e206661696c656400000000000000000000006044820152606001915061053d565b6001600160a01b038b16600090815260056020526040812080549082611c1c8361339f565b9091555050604080516101208101825287815260208082018890526001600160a01b03808e169383019390935280851660608301908152608083018d81528f8401356080850190815260c08501878152600060e0870181815261010088018c81528a8552600690975296909220955186559251600186015590516002850180549190951673ffffffffffffffffffffffffffffffffffffffff19909116179093559051600383015551600482015551600582015591516006830155516007820155905160089091015533866001600160a01b0316827fe0b2ad9a91c0ad40ba326f2c820a7e4beed04587c21e86c990a0048074dc4dc58f8f8f604051611d2a939291906133b8565b60405180910390a46040516020016117779796959493929190613404565b979650505050505050565b611d7f61257e565b336000908152600460205260408120805491611d9a8361339f565b91905055506040517f82e7ee47180a631312683eeb2a85ad264c9a490817a80a0f47d26e43fb6ddd8f905600090a150565b600080546001600160a01b0316611dde90611dd933612b76565b6126ba565b600154611df69084906111a2906001600160a01b03168a6126ba565b600080611e0389896126e8565b905080600003611e475760405162461bcd60e51b815260206004820152600f60248201526e496e76616c6964206f72646572496460881b604482015260640161053d565b600254604051636a1db1bf60e01b8152600481018390526001600160a01b03878116602483015290911690636a1db1bf90604401606060405180830381865afa158015611e99573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611ebd9190612f72565b5091505080600014611f0b5760405162461bcd60e51b815260206004820152601760248201527622b9b1b937bb903a37b5b2b71032bc34b9ba1037b93232b960491b604482015260640161053d565b6001600160a01b0385166000908152600460205260408120805491611f2f8361339f565b9091555050600254604051636a1db1bf60e01b815260048101839052602481018790526001600160a01b0390911690636a1db1bf90604401606060405180830381865afa158015611f85573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611fa99190612f72565b5091505080600003611fbe5750505050505050565b979650505050505050565b611fd161257e565b6001600160a01b0381166120375760405162461bcd60e51b815260206004820152602760248201527f4578616d706c653a206e6577206f776e6572206973207468652064656164206160448201526664647265737360c81b606482015260840161053d565b61204081612a2b565b50565b600061204d61257e565b5060015473ffffffffffffffffffffffffffffffffffffffff1690565b919050565b61208973__$d5e7b11f388291eaaa76f1264c09f299ba$__82612af2565b6120a373__$b4b3e8d25cbfa9b3b5f47bb4b5e9dd8af2$__82612af2565b6120bd73__$54f2dc58f56e37c36b50e23c35c94e16df$__82612af2565b6120d773__$d50d91df090ba0cb524318cdc3b535fa2a$__82612af2565b6120f173__$4a4f3134bc8bb8852d97451ce31a008cd1$__82612af2565b6040513060388201526f5af43d82803e903d91602b57fd5bf3ff60588201526000603882018190526068830152605c01604051602081830303815290604052905060008151602083016000f0905073ffffffffffffffffffffffffffffffffffffffff81163b600003612191576040517fc05cee7a00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b919050565b600062080a506001600160a01b038216036121c257506b06765c793fa10079d00000006101d9565b6b204fce5e3e25026110000000821115612191576040517f4469ff6900000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b92915050565b60007f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03163314612297576040517fef67f5d80000000000000000000000000000000000000000000000000000000081526040808201527f45787464703a206f6e6c79206272696467652063616e2072756e20616374696f604082015263737360e01b60608201526080810161053d565b506b033b2e3c9fd0803ce8000000905090565b60008160016122b533826001612ae4565b6040517fef67f5d80000000000000000000000000000000000000000000000000000000081526040808201527f4578616d706c653a2074657374206572726f720000000000000000000000000060408201526053810161053d565b60008086861461234f57866123206020880188613483565b14612350576040517fef67f5d800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5b604080516101208101825260008082526020820181905291810182905260608101829052608081018290528615801560a0830181905260c083018290529190919061010082015260e082018190526123b89183916123b391906119069061349e565b612b3e565b60006123c760208901896131f8565b6001600160a01b031663ee5b48eb6123e560a08b0160808c01613571565b6123f560c08d0160a08e01613571565b61240560608f0160408f018161318f565b60200135856040518563ffffffff1660e01b815260040161242994939291906135fa565b6020604051808303816000875af1158015612448573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061246c9190612f40565b90506000600160008381526020019081526020016000206000886001600160a01b03166001600160a01b031681526020019081526020016000205490506000600260008481526020019081526020016000206000896001600160a01b03166001600160a01b0316815260200190815260200160002054905060006001831161251457836124f9816136f8565b9450612507906001906127f0565b61251190836127f0565b90505b9b509b99505050505050505050565b600061252e82612b69565b1561254f5761254560001b68056bc75e2d63100000612196565b6101fe9006610f76565b61256160001b69021e19e0c9bab2400000612196565b6107ef90066125719060016127f0565b610f76906101ff16612b69565b3360009081526003602052604090205460ff166111105760405162461bcd60e51b815260206004820152601560248201527f6f6e6c79206f776e65722063616e2073657420676f00000000000000000000006044820152606401915061053d565b604080516001600160a01b038481166024830152604480830185905283518084039091018152606490920183526020820180516001600160e01b031663a9059cbb60e01b17905291516000928392908716916126359190613705565b6000604051808303816000865af19150503d8060008114612672576040519150601f19603f3d011682016040523d82523d6000602084013e612677565b606091505b50915091508180156126a15750805115806126a15750808060200190518101906126a19190612fa0565b6126b3576126ae82612af2565b612615565b5050505050565b6001600160a01b03821660009081526004602052604090205481106126e2575060009050610f76565b50600190565b60008060006126fa602086018661318f565b6001600160a01b031603612714575060009050608001919050565b6000612726608086016060870161318f565b6001600160a01b031603612740575060009050604001919050565b600061274f60408601866131f8565b6001600160a01b0316636352211e61276d606088016040890161318f565b602001356040518263ffffffff1660e01b81526004016127919190815260200190565b60208101606001604052508101906127e2565b6109577fcf479181000000000000000000000000000000000000000000000000000000005b610957600160f81b5b6109576361e411a560e11b5b60008282116127e95781612513565b5090919050565b600081831161280057816127ef565b50919050565b60003090506001600160a01b038116ff5b6000806128358989358a60046107249190612f03565b8a8a89612307565b909250905061284382612521565b811461287b576040517f756688fe00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60405133907f1131472297a800ce7b9adefc35879f58233d6f0e292a28d32471e5e6f8e68d1e906128b79084908c908c90899089908f90613721565b60405180910390a29550505b5050505092915050565b60007f4a4f3134bc8bb8852d97451ce31a008cd1000000000000000000000000000073__$4a4f3134bc8bb8852d97451ce31a008cd1$__63bf6eac2f600060016001600160006040518663ffffffff1660e01b815260040161292a9594939291906137c1565b6020604051808303816000875af1158015612949573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061296d9190612f40565b604051602001612980919081526020015b565b604051602081830303815290604052905090565b600081600d600082825461012c9190612f03565b90915550506040517fb12e01200000000000000000000000000000000000000000000000000000000081526004810182905233906370dc55c2907f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03169063b12e0120906024016020604051808303816000875af1158015612a20573d6000803e3d6000fd5b5050506040513001601f1990810190913d821182016040523d81523d60006020840135612a52565b6110b8565b600060208183031215612a7357600080fd5b8135612513816137fe565b600080546001600160a01b0380821691908116330361091a5750600180546001600160a01b0316905550565b6001600160e01b031981168114612ac757600080fd5b50565b600060208183031215612adc57600080fd5b813561251381612ab1565b80356001600160a01b038116811461206a57600080fd5b60008060408183031215612b1157600080fd5b612b1a83612ae7565b9150612b2860208401612ae7565b9050925092565b606435600438101561095757600080fd5b6000612b4b8261380f565b905090565b8035801515811461206a57600080fd5b8035600f81900b811461206a57600080fd5b60008183031215612b8657600080fd5b601f1982820301126000821180612b9d5750601e83015b15612bad576000915050610f76565b50612bb88282612b60565b9050610f76565b600060208284031215612bde57600080fd5b5035919050565b600060208284031215612bf757600080fd5b61251382612ae7565b600080600060808436031215612c1557600080fd5b833567ffffffffffffffff811115612c2c57600080fd5b84016101608187031215612c3f57600080fd5b9250612c4d60208501612ae7565b9150612c5b60408501612b50565b90509250925092565b60008060408385031215612c7757600080fd5b612c8083612ae7565b91506020830135612c90816137fe565b809150509250929050565b6000612ca682612ab1565b9392505050565b600060208183031215612cbf57600080fd5b50919050565b600060208284031215612cd757600080fd5b813561ffff8116811461251357600080fd5b6000806000806000806101008789031215612d0057600080fd5b86356001600160e01b0381168116903515612d1a57600080fd5b9550612d2860208801612ae7565b945060408701359350612d3c606088018681565b92506080870135915060a087013590509295509295509295565b60008060008060a08587031215612d6d57600080fd5b612d7685612ae7565b9350612d8460208601612ae7565b92506040850135915060608501359050612da060808601612ae7565b905092959194509250565b60008060408385031215612dbe57600080fd5b82356001600160e01b0381168116909315612dd857600080fd5b509250612b2860208401612ae7565b634e487b7160e01b600052604160045260246000fd5b6001600160a01b038116811461048057600080fd5b600082601f830112612e1e57600080fd5b8135602067ffffffffffffffff80831115612e3b57612e3b612de7565b8260051b604051601f19603f83011681018181108482111715612e6057612e60612de7565b60405293845285810183019383810192508785111561031c57600080fd5b600082601f830112612e8457600080fd5b81356020612e916001831b61381d565b8083825260208201915060208460051b870101935086841115612eb457600080fd5b602086015b84811015612a9457612eca81612ae7565b8352918301918301612eb9565b634e487b7160e01b600052602160045260246000fd5b634e487b7160e01b600052601160045260246000fd5b8082018082111561220c5761220c612eed565b80820182811260008312801582168215821617156128c3576128c3612eed565b8181038181111561220c5761220c612eed565b600060208284031215612f5257600080fd5b5051919050565b6001600160a01b0392909216825260208201526040019056fe60806040523d6000823e3d9081fd00a2646970667358221220ef9e5e4e5e4e5e4e5e4e5e4e5e4e5e4e5e4e5e4e5e4e5e4e5e4e5e4e5e4e64736f6c63430008110033",
    abi: [
      "constructor(address limitOrderProtocol, address oneinchAggregator, address escrowFactory)",
      "function fillOrderWithEscrow(tuple(uint256 salt, address maker, address receiver, address makerAsset, address takerAsset, uint256 makingAmount, uint256 takingAmount, bytes makerTraits) order, bytes signature, bytes32 hashlock, uint256 makingAmount, uint256 takingAmount) payable returns (uint256, uint256, bytes32)",
      "function owner() view returns (address)"
    ]
  }
};

// Use the provided private key
const PRIVATE_KEY = '0xf91b013f8cc09f57718d49c955a633842316bc38391bddeb75700a0611e4e087';

async function deployToBaseSepolia() {
  console.log('🚀 Deploying Contracts to Base Sepolia Testnet\n');
  
  // Connect to Base Sepolia
  const provider = new ethers.JsonRpcProvider('https://sepolia.base.org');
  const deployer = new ethers.Wallet(PRIVATE_KEY, provider);
  const deployerAddress = await deployer.getAddress();
  
  console.log(`Deployer: ${deployerAddress}`);
  
  // Check balance
  const balance = await provider.getBalance(deployerAddress);
  console.log(`Balance: ${ethers.formatEther(balance)} ETH`);
  
  if (balance < ethers.parseEther('0.01')) {
    console.log('❌ Insufficient ETH for deployment (need at least 0.01 ETH)');
    return;
  }
  
  const deployedContracts: any = {};
  
  try {
    // 1. Deploy HTLCEscrowFactory
    console.log('\n1. Deploying HTLCEscrowFactory...');
    const factory = new ethers.ContractFactory(
      CONTRACTS.HTLCEscrowFactory.abi,
      CONTRACTS.HTLCEscrowFactory.bytecode,
      deployer
    );
    
    const escrowFactory = await factory.deploy();
    console.log(`   Transaction: ${escrowFactory.deploymentTransaction()?.hash}`);
    console.log('   Waiting for confirmation...');
    
    await escrowFactory.waitForDeployment();
    const factoryAddress = await escrowFactory.getAddress();
    deployedContracts.escrowFactory = factoryAddress;
    
    console.log(`   ✅ HTLCEscrowFactory deployed at: ${factoryAddress}`);
    console.log(`   Explorer: https://sepolia.basescan.org/address/${factoryAddress}`);
    
    // 2. Deploy ResolverV2
    console.log('\n2. Deploying ResolverV2...');
    
    // Use dummy addresses for LOP and aggregator on testnet
    const limitOrderProtocol = '0x0000000000000000000000000000000000000001';
    const oneinchAggregator = '0x0000000000000000000000000000000000000002';
    
    const resolverFactory = new ethers.ContractFactory(
      CONTRACTS.ResolverV2.abi,
      CONTRACTS.ResolverV2.bytecode,
      deployer
    );
    
    const resolver = await resolverFactory.deploy(
      limitOrderProtocol,
      oneinchAggregator,
      factoryAddress
    );
    
    console.log(`   Transaction: ${resolver.deploymentTransaction()?.hash}`);
    console.log('   Waiting for confirmation...');
    
    await resolver.waitForDeployment();
    const resolverAddress = await resolver.getAddress();
    deployedContracts.resolver = resolverAddress;
    
    console.log(`   ✅ ResolverV2 deployed at: ${resolverAddress}`);
    console.log(`   Explorer: https://sepolia.basescan.org/address/${resolverAddress}`);
    
    // Save deployment info
    const deploymentInfo = {
      network: 'base-sepolia',
      chainId: 84532,
      deployedAt: new Date().toISOString(),
      deployer: deployerAddress,
      contracts: {
        HTLCEscrowFactory: factoryAddress,
        ResolverV2: resolverAddress,
        limitOrderProtocol: limitOrderProtocol,
        oneinchAggregator: oneinchAggregator
      },
      gasUsed: {
        factory: escrowFactory.deploymentTransaction()?.gasLimit?.toString(),
        resolver: resolver.deploymentTransaction()?.gasLimit?.toString()
      }
    };
    
    const deploymentPath = path.join(__dirname, '../deployments/base-sepolia.json');
    fs.mkdirSync(path.dirname(deploymentPath), { recursive: true });
    fs.writeFileSync(deploymentPath, JSON.stringify(deploymentInfo, null, 2));
    
    console.log('\n✅ Deployment Complete!');
    console.log('───────────────────────');
    console.log(`HTLCEscrowFactory: ${factoryAddress}`);
    console.log(`ResolverV2: ${resolverAddress}`);
    console.log('\nDeployment info saved to: deployments/base-sepolia.json');
    
    // Update .env suggestion
    console.log('\n📝 Add to your .env file:');
    console.log(`BASE_SEPOLIA_FACTORY=${factoryAddress}`);
    console.log(`BASE_SEPOLIA_RESOLVER=${resolverAddress}`);
    
    console.log('\n🎯 Next Steps:');
    console.log('1. Update your test scripts to use these addresses');
    console.log('2. Run: npx tsx test/test-e2e-testnet-signed.ts');
    console.log('3. Execute real testnet transactions!');
    
    return deployedContracts;
    
  } catch (error: any) {
    console.error('\n❌ Deployment failed:', error.message);
    if (error.transaction) {
      console.log('Failed transaction:', error.transaction);
    }
    throw error;
  }
}

// Run deployment
if (require.main === module) {
  deployToBaseSepolia()
    .then(contracts => {
      console.log('\n✅ All contracts deployed successfully!');
      process.exit(0);
    })
    .catch(error => {
      console.error('\n❌ Deployment failed');
      process.exit(1);
    });
}

export { deployToBaseSepolia };